# User Service

## Introduction

This is the base user service that manages user profile information across multiple applications. The service provides CRUD operations for user profiles with a flexible, extensible design that can handle diverse user attributes without requiring schema changes.

## Architecture Overview

The user service uses an **Entity-Attribute-Value (EAV)** pattern for profile data while reading core user information from a shared database table managed by the Auth Service. This allows the service to handle any user profile attributes dynamically while maintaining a simple interface for consuming applications.

### Key Features

- **Flexible Schema**: Support for any user profile attributes without database migrations
- **Clean API**: External services see a simple, normalized payload
- **Shared Identity**: Reads core user data from Auth Service's user table
- **High Performance**: Optimized queries with caching for frequently accessed attributes
- **Multi-Application Support**: Single service can serve multiple applications with different user data requirements

## Database Structure

The service uses a shared database approach with the Auth Service, following the project's schema-based organization:

### Schema Organization
- **Shared Schema**: `sr_auth` - Contains the shared users table
- **User Service Schema**: `sr_user` - Contains EAV tables for profile management

### 1. Shared Users Table (Managed by Auth Service)
Located in `sr_auth` schema, stores core user identity information:
- `id` (INTEGER): Primary key (auto-increment)
- `uuid` (UUID): Unique identifier (generated by Auth Service)
- `email` (VARCHAR): Unique email address
- `phone` (VARCHAR): Unique phone number (optional)
- `password_hash` (VARCHAR): Hashed password
- `is_active` (BOOLEAN): User status
- `meta` (JSONB): Additional metadata
- `created_at` (TIMESTAMPTZ): Creation timestamp
- `updated_at` (TIMESTAMPTZ): Last update timestamp
- `deleted_at` (TIMESTAMPTZ): Soft delete timestamp (NULL by default)

**Note**: User Service has **read-only access** to this table.

### 2. User Attributes Table (Managed by User Service)
Located in `sr_user` schema, defines available profile attributes:
- `id` (INTEGER): Primary key (auto-increment)
- `uuid` (UUID): Unique identifier
- `name` (VARCHAR): Attribute name (e.g., "first_name", "gender")
- `data_type` (VARCHAR): Data type ("string", "integer", "boolean", "date")
- `is_required` (BOOLEAN): Whether the attribute is mandatory
- `is_searchable` (BOOLEAN): Whether the attribute can be searched
- `meta` (JSONB): Additional metadata
- `created_at` (TIMESTAMPTZ): Creation timestamp
- `updated_at` (TIMESTAMPTZ): Last update timestamp
- `deleted_at` (TIMESTAMPTZ): Soft delete timestamp (NULL by default)

### 3. User Attribute Values Table (Managed by User Service)
Located in `sr_user` schema, stores actual profile attribute values:
- `id` (INTEGER): Primary key (auto-increment)
- `uuid` (UUID): Unique identifier
- `user_uuid` (UUID): Reference to shared users table (no FK constraint)
- `attribute_id` (INTEGER): Reference to user_attributes table (FK within schema)
- `value` (TEXT): The actual attribute value
- `meta` (JSONB): Additional metadata
- `created_at` (TIMESTAMPTZ): Creation timestamp
- `updated_at` (TIMESTAMPTZ): Last update timestamp
- `deleted_at` (TIMESTAMPTZ): Soft delete timestamp (NULL by default)

## Service Responsibilities

### Auth Service
- **Creates** user records in the shared `users` table
- **Manages** user identity (email, phone, password)
- **Handles** authentication and authorization
- **Generates** user UUIDs
- **Updates** password and account status

### User Service
- **Reads** core user data from shared `users` table
- **Manages** profile attributes in EAV tables
- **Provides** complete user information by combining core + profile data
- **Handles** profile-specific CRUD operations

## API Interface

### External API (Clean & Simple)
The service exposes a clean API where external services send normalized payloads:

```json
{
  "user_id": "uuid-from-auth-service",
  "profile_data": {
    "first_name": "John",
    "last_name": "Doe",
    "gender": "male",
    "profile_image": "https://example.com/avatar.jpg",
    "date_of_birth": "1990-01-01",
    "company": "Acme Corp",
    "address": "123 Main St"
  }
}
```

### Complete User Response
When retrieving user data, the service combines core user data with profile attributes:

```json
{
  "id": "uuid-from-auth-service",
  "email": "user@example.com",
  "phone": "+1234567890",
  "is_active": true,
  "created_at": "2024-01-01T00:00:00Z",
  "profile_data": {
    "first_name": "John",
    "last_name": "Doe",
    "gender": "male",
    "profile_image": "https://example.com/avatar.jpg"
  }
}
```

### Internal Processing
The service internally:
1. **Reads** core user data from shared `users` table
2. **Dynamically creates** attribute definitions if they don't exist
3. **Stores** profile data in EAV structure
4. **Resolves** and returns combined data to external consumers

## Functions

### Profile Management
- **Create User Profile**: Create profile for existing user (requires valid user_id)
- **Update User Profile**: Update user profile information and attributes
- **Delete User Profile**: Remove user profile data (keeps core user record)
- **Delete User Profiles (Bulk)**: Bulk delete multiple user profiles

### User Retrieval
- **Get User by ID**: Retrieve complete user information (core + profile)
- **Get User by Email**: Retrieve user by email address
- **List All Users**: Get all users with profiles and pagination
- **List Users and Paginate**: Advanced listing with filtering and search

### Attribute Management (Internal)
- **Dynamic Attribute Creation**: Automatically creates attribute definitions
- **Attribute Resolution**: Efficiently resolves user attributes from EAV structure
- **Caching**: Redis-based caching for frequently accessed attributes

## Configuration

### Initial Attribute Setup
The service automatically creates attribute definitions when first encountered, or you can pre-configure common attributes:

```sql
-- Insert into sr_user.user_attributes table
INSERT INTO sr_user.user_attributes (uuid, name, data_type, is_required, is_searchable, meta, created_at, updated_at) VALUES
(gen_random_uuid(), 'first_name', 'string', true, true, '{"display_name": "First Name", "validation": {"min_length": 1, "max_length": 50}}', NOW(), NOW()),
(gen_random_uuid(), 'last_name', 'string', true, true, '{"display_name": "Last Name", "validation": {"min_length": 1, "max_length": 50}}', NOW(), NOW()),
(gen_random_uuid(), 'gender', 'string', false, false, '{"display_name": "Gender", "options": ["male", "female", "other"]}', NOW(), NOW()),
(gen_random_uuid(), 'profile_image', 'string', false, false, '{"display_name": "Profile Image", "validation": {"pattern": "^https?://.*"}}', NOW(), NOW()),
(gen_random_uuid(), 'date_of_birth', 'date', false, false, '{"display_name": "Date of Birth"}', NOW(), NOW()),
(gen_random_uuid(), 'company', 'string', false, false, '{"display_name": "Company", "validation": {"max_length": 100}}', NOW(), NOW()),
(gen_random_uuid(), 'address', 'string', false, false, '{"display_name": "Address", "validation": {"max_length": 200}}', NOW(), NOW());
```

### Performance Optimization
- **Indexing**: Optimized indexes on frequently queried attributes
- **Caching**: Redis cache for attribute definitions and user data
- **Query Optimization**: Efficient EAV resolution with minimal joins

## Integration

### Auth Service Integration
- **Reads** from shared `users` table (read-only access)
- **Requires** valid user_id from auth service for profile operations
- **Assumes** user exists in auth service before creating profile
- **Maintains** data consistency through application logic

### Application Service Integration
- **Clean gRPC interface**
- **Normalized request/response payloads**
- **No knowledge of internal EAV implementation required**
- **Receives user_id from auth service**

## Benefits

1. **Clear Separation**: Auth service manages identity, User service manages profiles
2. **Flexibility**: Add new profile attributes without code changes
3. **No Data Duplication**: Single source of truth for core user data
4. **Scalability**: Efficient handling of diverse profile data requirements
5. **Maintainability**: Clean separation between internal storage and external API
6. **Performance**: Optimized queries and caching for production workloads
7. **Multi-Tenancy**: Single service can serve multiple applications with different needs